<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout/base :: head (title='Estadísticas - Metamapa')}"></head>
<body class="bg-pastel-blue-50 flex flex-col min-h-screen">

<div th:replace="~{layout/base :: header}"></div>

<main class="container mx-auto px-4 py-8 flex-grow">
    <div class="space-y-8">
        <div class="flex justify-between items-center">

            <h1 class="text-3xl font-bold text-pastel-blue-900">Estadísticas</h1>

            <a th:href="@{/csv}"
               class="bg-pastel-blue-700 text-white font-bold py-2 px-4 rounded shadow-md hover:bg-pastel-blue-800 transition-colors">
                Exportar
            </a>

        </div>
        <th:block th:if="${estadisticas != null}">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

                <div class="bg-white p-4 rounded-lg shadow-md border border-pastel-blue-200">
                    <h3 class="text-lg font-bold text-pastel-blue-800 border-b border-pastel-blue-200 pb-2 mb-3">Provincia con más Hechos por Colección</h3>
                    <form method="get" th:action="@{/estadisticas}" class="contents">
                        <input type="hidden" name="categoriaSeleccionada" th:value="${categoriaSeleccionada}" />
                        <input type="hidden" name="categoriaParaHoraPico" th:value="${categoriaParaHoraPico}" />
                        <div class="space-y-3">
                            <select name="coleccionSeleccionadaId" onchange="this.form.submit()" class="w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md">
                                <option value="">Seleccione una colección</option>
                                <option th:each= "col : ${colecciones}"
                                        th:value="${col.coleccionId}"
                                        th:text="${col.titulo}"
                                        th:selected="${col.coleccionId == coleccionSeleccionadaId}"></option>
                            </select>
                            <div th:if="${provinciaPorColeccion != null}" class="mt-4 overflow-x-auto rounded-lg border border-pastel-blue-300">
                                <table class="min-w-full divide-y divide-pastel-blue-300">
                                    <thead class="bg-pastel-blue-100">
                                    <tr>
                                        <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-pastel-blue-700 uppercase tracking-wider">
                                            Provincia
                                        </th>
                                        <th scope="col" class="px-4 py-2 text-right text-xs font-medium text-pastel-blue-700 uppercase tracking-wider">
                                            Condición
                                        </th>
                                    </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                    <tr class="hover:bg-pastel-blue-50">
                                        <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold text-pastel-blue-900" th:text="${provinciaPorColeccion}"></td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-right font-medium text-pastel-blue-700">Más Hechos</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                            <p th:if="${provinciaPorColeccion == null and coleccionSeleccionadaId != null}" class="text-center text-sm text-gray-500 py-4">No hay datos para esta colección.</p>
                        </div>
                    </form>
                </div>

                <div class="bg-white p-4 rounded-lg shadow-md border border-pastel-blue-200">
                    <h3 class="text-lg font-bold text-pastel-blue-800 border-b border-pastel-blue-200 pb-2 mb-3">Categoría más Reportada</h3>
                    <div class="text-center">
                        <p class="text-3xl font-bold text-pastel-blue-700" th:text="${estadisticas.categoriaConMasHechos}"></p>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg shadow-md border border-pastel-blue-200">
                    <h3 class="text-lg font-bold text-pastel-blue-800 border-b border-pastel-blue-200 pb-2 mb-3">Provincia con más Hechos por Categoría</h3>
                    <form method="get" th:action="@{/estadisticas}" class="contents">
                        <input type="hidden" name="coleccionSeleccionadaId" th:value="${coleccionSeleccionadaId}" />
                        <input type="hidden" name="categoriaParaHoraPico" th:value="${categoriaParaHoraPico}" />
                        <div class="space-y-3">
                            <select name="categoriaSeleccionada" onchange="this.form.submit()" class="w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md">
                                <option value="">Seleccione una categoría</option>
                                <option th:each="cat : ${estadisticas.provinciaConMasHechosDeCategoria.keySet()}"
                                        th:value="${cat}"
                                        th:text="${cat}"
                                        th:selected="${cat == categoriaSeleccionada}"></option>
                            </select>
                            <div th:if="${provinciaPorCategoria != null}" class="mt-4 overflow-x-auto rounded-lg border border-pastel-blue-300">
                                <table class="min-w-full divide-y divide-pastel-blue-300">
                                    <thead class="bg-pastel-blue-100">
                                    <tr>
                                        <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-pastel-blue-700 uppercase tracking-wider">
                                            Provincia
                                        </th>
                                        <th scope="col" class="px-4 py-2 text-right text-xs font-medium text-pastel-blue-700 uppercase tracking-wider">
                                            Condición
                                        </th>
                                    </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                    <tr class="hover:bg-pastel-blue-50">
                                        <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold text-pastel-blue-900" th:text="${provinciaPorCategoria}"></td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-right font-medium text-pastel-blue-700">Más Hechos</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                            <p th:if="${provinciaPorCategoria == null and categoriaSeleccionada != null}" class="text-center text-sm text-gray-500 py-4">No hay datos para esta categoría.</p>
                        </div>
                    </form>
                </div>

                <div class="bg-white p-4 rounded-lg shadow-md border border-pastel-blue-200">
                    <h3 class="text-lg font-bold text-pastel-blue-800 border-b border-pastel-blue-200 pb-2 mb-3">Solicitudes de Eliminación Spam</h3>
                    <div class="text-center">
                        <p class="text-4xl font-bold text-pastel-blue-700" th:text="${estadisticas.cantidadSolicitudesSpam}"></p>
                        <p class="text-md text-gray-600">solicitudes marcadas como spam</p>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg shadow-md border border-pastel-blue-200">
                    <h3 class="text-lg font-bold text-pastel-blue-800 border-b border-pastel-blue-200 pb-2 mb-3">Hora Pico por Categoría</h3>
                    <form method="get" th:action="@{/estadisticas}" class="contents">
                        <input type="hidden" name="coleccionSeleccionadaId" th:value="${coleccionSeleccionadaId}" />
                        <input type="hidden" name="categoriaSeleccionada" th:value="${categoriaSeleccionada}" />
                        <div class="space-y-3">
                            <select name="categoriaParaHoraPico" onchange="this.form.submit()" class="w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md">
                                <option value="">Seleccione una categoría</option>
                                <option th:each="cat : ${estadisticas.horaConMasHechosPorCategoria.keySet()}"
                                        th:value="${cat}"
                                        th:text="${cat}"
                                        th:selected="${cat == categoriaParaHoraPico}"></option>
                            </select>
                            <div th:if="${horaPicoParaCategoria != null}" class="mt-4 overflow-x-auto rounded-lg border border-pastel-blue-300">
                                <table class="min-w-full divide-y divide-pastel-blue-300">
                                    <thead class="bg-pastel-blue-100">
                                    <tr>
                                        <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-pastel-blue-700 uppercase tracking-wider">
                                            Hora
                                        </th>
                                        <th scope="col" class="px-4 py-2 text-right text-xs font-medium text-pastel-blue-700 uppercase tracking-wider">
                                            Condición
                                        </th>
                                    </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                    <tr class="hover:bg-pastel-blue-50">
                                        <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold text-pastel-blue-900" th:text="|${#numbers.formatInteger(horaPicoParaCategoria, 2)}:00 hs|"></td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-right font-medium text-pastel-blue-700">Hora Pico</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                            <p th:if="${horaPicoParaCategoria == null and categoriaParaHoraPico != null}" class="text-center text-sm text-gray-500 py-4">No hay datos para esta categoría.</p>
                        </div>
                    </form>
                </div>

            </div>
        </th:block>
    </div>
</main>

<div th:replace="~{layout/base :: footer}"></div>
<div th:replace="~{layout/base :: scripts}"></div>

</body>
</html>