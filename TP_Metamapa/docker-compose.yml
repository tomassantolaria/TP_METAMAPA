version: "3.8"

services:

  # -----------------------
  # BASES DE DATOS (MySQL)
  # -----------------------
  db_general:
    image: mysql:8.0
    container_name: db_general
    command: --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_ROOT_PASSWORD: root
    volumes:
      - db_data:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s
    networks:
      - default

  # -----------------------
  # KEYCLOAK (Conectado a MySQL)
  # -----------------------
  keycloak:
    image: quay.io/keycloak/keycloak:26.4.5
    container_name: keycloak
    command: ["start-dev", "--import-realm"]
    depends_on:
      db_general:
        condition: service_healthy
    volumes:
       - ./keycloak/import:/opt/keycloak/data/import
    ports:
      - "9090:8080"
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_DB: mysql
      KC_DB_POOL_INITIAL_SIZE: 1
      KC_DB_POOL_MIN_SIZE: 1
      KC_DB_POOL_MAX_SIZE: 5
      KC_DB_POOL_ACQUISITION_TIMEOUT: 60
      JAVA_MAX_MEM: 1024m

      QUARKUS_DATASOURCE_JDBC_ACQUISITION_TIMEOUT: 60s
      KC_DB_URL: jdbc:mysql://db_general/keycloak
      KC_DB_USERNAME: root
      KC_DB_PASSWORD: root
      KC_DB_ROOT_PASSWORD: root
      KC_HOSTNAME: localhost
      KC_HOSTNAME_STRICT: "false"
      KC_HTTP_ENABLED: "true"
      KC_PROXY_HEADERS: "xforwarded"
      JAVA_OPTS: "-Xms256m -Xmx512m"

    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/127.0.0.1/8080;echo -e 'GET /health/ready HTTP/1.1\r\nhost: localhost\r\nConnection: close\r\n\r\n' >&3;grep 'HTTP/1.1 200 OK' <&3"]
      interval: 10s
      timeout: 10s
      retries: 30

  # -----------------------
  # MICROSERVICIOS
  # -----------------------

  moduloagregador:
    container_name: moduloagregador
    build:
      context: .
      dockerfile: ModuloAgregador/Dockerfile
    depends_on:
      db_general:
        condition: service_healthy
      modulodinamica:
        condition: service_healthy
      moduloproxy:
          condition: service_healthy
      moduloestatica:
        condition: service_healthy
      modulonormalizador:
        condition: service_healthy
      modulopublico:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: prod
      DB_URL: jdbc:mysql://db_general:3306/comun
      DB_USER: root
      DB_PASSWORD: root
    ports:
      - "8080:8080"
    restart: on-failure
    healthcheck:
      test: "curl --fail --silent http://localhost:8080/actuator/health || exit 1"
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s

  moduloavd:
    container_name: moduloavd
    build:
      context: .
      dockerfile: ModuloAVD/Dockerfile
    depends_on:
      db_general:
        condition: service_healthy
      modulopublico:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: prod
      DB_URL: jdbc:mysql://db_general:3306/comun
      DB_USER: root
      DB_PASSWORD : root
    ports:
      - "8081:8081"
    restart: on-failure
    healthcheck:
      test: "curl --fail --silent http://localhost:8081/actuator/health || exit 1"
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s

  modulodinamica:
    container_name: modulodinamica
    build:
      context: .
      dockerfile: ModuloDinamica/Dockerfile
    depends_on:
      db_general:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: prod
      DB_URL: jdbc:mysql://db_general:3306/dinamica
      DB_USER: root
      DB_PASSWORD : root
    ports:
      - "8082:8082"
    restart: on-failure
    healthcheck:
      test: "curl --fail --silent http://localhost:8082/actuator/health || exit 1"
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s

  moduloestadisticas:
    container_name: moduloestadisticas
    build:
      context: .
      dockerfile: ModuloEstadisticas/Dockerfile
    depends_on:
      db_general:
        condition: service_healthy
      moduloagregador:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: prod
      DB_URL: jdbc:mysql://db_general:3306/comun
      DB_USER: root
      DB_PASSWORD : root
    ports:
      - "8083:8083"
    restart: on-failure
    healthcheck:
      test: "curl --fail --silent http://localhost:8083/actuator/health || exit 1"
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s

  moduloestatica:
    container_name: moduloestatica
    build:
      context: .
      dockerfile: ModuloEstatica/Dockerfile
    depends_on:
      db_general:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: prod
      DB_URL: jdbc:mysql://db_general:3306/estatica
      DB_USER: root
      DB_PASSWORD : root
      PATH_ARCHIVOS: "/app/data/"
    volumes:
      - ./archivos_data:/app/data
    ports:
      - "8084:8084"
    restart: on-failure
    healthcheck:
      test: "curl --fail --silent http://localhost:8084/actuator/health || exit 1"
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s

  modulonormalizador:
    container_name: modulonormalizador
    build:
      context: .
      dockerfile: ModuloNormalizador/Dockerfile
    environment:
      SPRING_PROFILES_ACTIVE: prod
    ports:
      - "8085:8085"
    restart: on-failure
    healthcheck:
      test: "curl --fail --silent http://localhost:8085/actuator/health || exit 1"
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s

  moduloproxy:
    container_name: moduloproxy
    build:
      context: .
      dockerfile: ModuloProxy/Dockerfile
    depends_on:
       db_general:
         condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: prod
      DB_URL: jdbc:mysql://db_general:3306/proxy
      DB_USER: root
      DB_PASSWORD : root
    ports:
      - "8086:8086"
    restart: on-failure
    healthcheck:
      test: "curl --fail --silent http://localhost:8086/actuator/health || exit 1"
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s

  modulopublico:
    container_name: modulopublico
    build:
      context: .
      dockerfile: ModuloPublico/Dockerfile
    depends_on:
      db_general:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: prod
      DB_URL: jdbc:mysql://db_general:3306/comun
      DB_USER: root
      DB_PASSWORD : root
    ports:
      - "8087:8087"
    restart: on-failure
    healthcheck:
      test: "curl --fail --silent http://localhost:8087/actuator/health || exit 1"
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s

  moduloauth:
    container_name: moduloauth
    build:
      context: .
      dockerfile: ModuloAuth/Dockerfile
    depends_on:
      - keycloak
    ports:
      - "9092:9092"
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SERVER_URL: http://keycloak:8080
      REALM_NAME: spring-boot-realm-pr
      RESOURSE_ID: spring-client-api-rest
      CLIENT_SECRET: "tTgQRBnJcW9i77KnM8clU9qz0ivJtB5D"
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: http://localhost:8080/realms/spring-boot-realm-pr
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI: http://keycloak:8080/realms/spring-boot-realm-pr/protocol/openid-connect/certs
    restart: on-failure
    healthcheck:
      test: "curl --fail --silent http://localhost:9092/actuator/health || exit 1"
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s

  frontend:
    container_name: frontend
    build:
      context: .
      dockerfile: FrontEnd/Dockerfile
    depends_on:
      moduloauth:
        condition: service_healthy
      moduloavd:
        condition: service_healthy
      moduloestadisticas:
        condition: service_healthy
      moduloestatica:
        condition: service_healthy
      moduloproxy:
        condition: service_healthy
      modulopublico:
        condition: service_healthy
      modulodinamica:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: prod
      KEYCLOAK_PUBLIC_URL: http://localhost:9090
      KEYCLOAK_URL: http://keycloak:8080
      AUTH_URL: http://moduloauth:9092
    ports:
      - "8088:8088"
    restart: on-failure
    healthcheck:
      test: "curl --fail --silent http://localhost:8088/actuator/health || exit 1"
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s

  # -----------------------
  # OBSERVABILIDAD
  # -----------------------

  # 1. Zipkin: Recolecta trazas distribuidas
  zipkin:
    image: openzipkin/zipkin
    container_name: zipkin
    ports:
       - "9411:9411"
    environment:
       - JAVA_OPTS=-Xmx256m # Limitamos RAM
    networks:
          - default

  # 2. Prometheus: Recolecta mÃ©tricas cada X segundos
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9091:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
    depends_on:
      - modulonormalizador
    networks:
      - default

      # 3. Grafana: Panel visual para ver todo
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    depends_on:
      - prometheus
      - loki
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
          - default
  loki:
    image: grafana/loki:latest
    container_name: loki
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - ./loki-config.yml:/etc/loki/local-config.yaml
      - loki_data:/loki
    networks:
      - default
  promtail:
    image: grafana/promtail:latest
    container_name: promtail
    user: root
    volumes:
      # Montar el socket de Docker y el directorio de logs para el descubrimiento
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./promtail-config.yml:/etc/promtail/config.yml
    command: -config.file=/etc/promtail/config.yml
    networks:
      - default
    depends_on:
      - loki
volumes:
  db_data:
  grafana_data:
  loki_data: