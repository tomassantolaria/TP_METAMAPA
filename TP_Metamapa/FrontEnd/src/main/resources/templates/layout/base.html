<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security6">
<head th:fragment="head">
    <meta charset="UTF-8">
    <title th:text="${title} ?: 'MetaMapa'">MetaMapa</title>

    <!-- Tailwind / build CSS (no tocar) -->
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <!-- Tus overrides custom (cargado después de style.css) -->
    <link rel="stylesheet" th:href="@{/css/custom.css}">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        #map { height: 400px; width: 100%; border-radius: 0.375rem; border: 1px solid #d1d5db; }
    </style>

    <link rel="icon" th:href="@{/images/logo.png}" type="image/png">
</head>
<body>

<header th:fragment="header" class="bg-pastel-blue-100 shadow-md sticky top-0 z-[1000]">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <img th:src="@{/images/logo.png}" alt="MetaMapa Logo" class="w-10 h-10">
            <a th:href="@{/}" class="text-2xl font-bold text-pastel-blue-900 pt-3 tracking-tight">
                MetaMapa
            </a>
        </div>

        <nav class="flex items-center gap-2 md:gap-4">
            <a th:href="@{/}"
               th:classappend="${activePage == 'inicio'} ? ' bg-pastel-blue-300 text-pastel-blue-900 font-semibold' : ''"
               class="flex items-center gap-2 px-4 py-2 rounded-md transition-colors text-pastel-blue-800 hover:bg-pastel-blue-200">
                <span>Inicio</span>
            </a>
            <a th:href="@{/navegar}"
               th:classappend="${activePage == 'navegar'} ? ' bg-pastel-blue-300 text-pastel-blue-900 font-semibold' : ''"
               class="flex items-center gap-2 px-4 py-2 rounded-md transition-colors text-pastel-blue-800 hover:bg-pastel-blue-200">
                <span>Navegar</span>
            </a>
            <a th:href="@{/estadisticas}"
               th:classappend="${activePage == 'estadisticas'} ? ' bg-pastel-blue-300 text-pastel-blue-900 font-semibold' : ''"
               class="flex items-center gap-2 px-4 py-2 rounded-md transition-colors text-pastel-blue-800 hover:bg-pastel-blue-200">
                <span>Estadísticas</span>
            </a>
        </nav>

        <div class="flex items-center gap-3">
            <div sec:authorize="isAuthenticated()" class="flex items-center gap-3">
                <a th:href="@{/crear-hecho}" class="hidden md:inline-flex items-center gap-1 bg-pastel-blue-600 text-white px-3 py-1.5 rounded-md text-sm font-medium hover:bg-pastel-blue-700">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>
                    Crear Hecho
                </a>
                <a sec:authorize="hasRole('admin_client_role')" th:href="@{/admin}" class="hidden md:inline-flex items-center gap-1 bg-pastel-blue-600 text-white px-3 py-1.5 rounded-md text-sm font-medium hover:bg-pastel-blue-700">
                    Panel de Administración
                </a>
                <div class="relative" id="profile-menu-container">
                    <button id="profile-menu-button" class="w-10 h-10 rounded-full bg-pastel-blue-300 flex items-center justify-center text-pastel-blue-800 hover:bg-pastel-blue-400 focus:outline-none focus:ring-2 focus:ring-pastel-blue-500 focus:ring-offset-2">
                        <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    </button>
                    <div id="profile-menu-dropdown" class="absolute hidden right-0 mt-2 w-56 bg-white rounded-md shadow-lg py-1 ring-1 ring-black ring-opacity-5 z-10 dropdown-menu-content">
                        <div class="px-4 py-2 border-b">
                            <p class="text-sm font-semibold text-gray-700" sec:authentication="name"></p>
                        </div>

                        <a th:href="@{/hechos-pendientes}"
                           class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-pastel-blue-100">
                            Ver hechos pendientes
                        </a>

                        <form th:action="@{/logout}" method="post" class="w-full">
                            <button type="submit" class="w-full text-left flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-pastel-blue-100">Cerrar Sesión</button>
                        </form>
                    </div>
                </div>
            </div>

            <div sec:authorize="isAnonymous()">
                <a th:href="@{/auth/login}" class="bg-pastel-blue-600 text-white px-3 py-1.5 rounded-md text-sm font-medium hover:bg-pastel-blue-700">
                    Iniciar Sesión
                </a>
            </div>
            <div sec:authorize="isAnonymous()">
                <a th:href="@{/auth/register}" class="bg-white text-pastel-blue-600 px-3 py-1.5 rounded-md text-sm font-medium">
                    Registrarse
                </a>
            </div>
        </div>
    </div>
</header>

<!-- MAIN: ahora centramos y delegamos el padding al content-wrapper -->
<main class="w-full flex justify-center my-8">
    <div class="content-wrapper w-full max-w-screen-xl px-6 md:px-10 lg:px-16" th:fragment="content"></div>
</main>

<footer th:fragment="footer" class="bg-pastel-blue-200 mt-8 bottom-0 z-[1000]">
    <div class="container mx-auto px-4 py-4 text-center text-pastel-blue-700">
        <p>&copy; 2025 MetaMapa. Todos los derechos reservados.</p>
    </div>
</footer>

<div th:fragment="scripts">
    <script th:inline="javascript">
        window.toggleMenu = function(menuId) {
           const menuToToggle = document.getElementById(menuId);
           if (!menuToToggle) return;
           menuToToggle.classList.toggle('hidden');
       };

       document.addEventListener('DOMContentLoaded', function() {
           const profileMenuButton = document.getElementById('profile-menu-button');
           const profileMenuDropdown = document.getElementById('profile-menu-dropdown');

           if (profileMenuButton && profileMenuDropdown) {
               profileMenuButton.addEventListener('click', function(event) {
                   event.stopPropagation(); // Evita que el clic se propague al 'document'
                   profileMenuDropdown.classList.toggle('hidden');
               });
           }
       });

        document.addEventListener('click', function(event) {
           const profileMenuContainer = document.getElementById('profile-menu-container');
           const profileMenuDropdown = document.getElementById('profile-menu-dropdown');
           if (profileMenuContainer && profileMenuDropdown && !profileMenuDropdown.classList.contains('hidden')) {
               if (!profileMenuContainer.contains(event.target)) {
                   profileMenuDropdown.classList.add('hidden');
               }
           }

           document.querySelectorAll('[id^="menu-button-"]').forEach(button => {
               const menuId = 'menu-' + button.id.substring(12);
               const menu = document.getElementById(menuId);

               if (menu && !menu.classList.contains('hidden')) {
                   if (!button.contains(event.target)) {
                       menu.classList.add('hidden');
                   }
               }
           });
       });

    </script>
</div>
</body>
</html>
