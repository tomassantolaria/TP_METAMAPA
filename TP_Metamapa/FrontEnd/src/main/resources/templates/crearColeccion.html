<!DOCTYPE html>
<html lang="es">
<head th:replace="~{layout/base :: head (title='Crear Colección - Metamapa')}">
    <title>Crear Colección</title>
</head>
<body class="bg-gray-50">
<div th:replace="~{layout/base :: header}"></div>

<main class="container mx-auto px-4 py-8">
    <div class="max-w-3xl mx-auto bg-white p-6 rounded-lg shadow-md border border-blue-200">
        <h1 class="text-3xl font-bold text-blue-900 mb-6">Crear Colección</h1>

        <form class="space-y-4" action="#" method="POST">

            <!-- Título -->
            <div>
                <label for="titulo" class="block text-sm font-medium text-gray-700">Título</label>
                <input type="text" id="titulo" name="titulo" required
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" />
            </div>

            <!-- Descripción -->
            <div>
                <label for="descripcion" class="block text-sm font-medium text-gray-700">Descripción</label>
                <textarea id="descripcion" name="descripcion" rows="3" required
                          class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
            </div>

            <!-- Criterio de Consenso -->
            <div>
                <label for="criterioConsenso" class="block text-sm font-medium text-gray-700">Criterio de Consenso</label>
                <select id="criterioConsenso" name="criterioConsenso"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                    <option value="MAYORIA_SIMPLE">Mayoría simple</option>
                    <option value="ABSOLUTA">Absoluta</option>
                    <option value="MULTIPLES_MENCIONES">Múltiples menciones</option>
                </select>
            </div>

            <!-- Criterios de Pertenencia -->
            <fieldset class="border-t border-gray-200 pt-5">
                <legend class="text-base font-medium text-gray-900 mb-2">Criterio de Pertenencia</legend>
                <p class="text-sm text-gray-500 mb-3">
                    Defina las reglas para que los hechos pertenezcan a esta colección. Complete al menos un campo.
                </p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="titulo-criterio" class="block text-sm font-medium text-gray-700">Título contiene</label>
                        <input type="text" id="titulo-criterio" name="titulo-criterio"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" />
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="categoria" class="block text-sm font-medium text-gray-700">Categoría</label>
                            <select name="categoria" id="categoria" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md">
                                <option value="" disabled selected>Selecciona una categoría</option>
                                <option th:each="cat : ${categorias}"
                                        th:value="${cat}"
                                        th:text="${cat}"></option>
                            </select>
                        </div>

                        <div id="customCategoriaDiv" class="hidden">
                            <label for="customCategoria" class="block text-sm font-medium text-gray-700">Nueva Categoría</label>
                            <input type="text" name="customCategoria" id="customCategoria"
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"/>
                        </div>
                    </div>

                    <!-- Buscador de ubicación -->
                    <div class="md:col-span-2">
                        <label for="searchDireccion" class="block text-sm font-medium text-gray-700">Buscar dirección</label>
                        <div class="flex gap-2">
                            <input type="text" id="searchDireccion" placeholder="Ejemplo: Rosario, Santa Fe, Argentina"
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"/>
                            <button type="button" id="buscarUbicacion"
                                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                Buscar
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Ingrese una dirección o ciudad para autocompletar país, provincia y localidad.</p>
                    </div>

                    <div>
                        <label for="pais" class="block text-sm font-medium text-gray-700">País</label>
                        <input type="text" id="pais" name="pais"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" />
                    </div>

                    <div>
                        <label for="provincia" class="block text-sm font-medium text-gray-700">Provincia</label>
                        <input type="text" id="provincia" name="provincia"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" />
                    </div>

                    <div>
                        <label for="localidad" class="block text-sm font-medium text-gray-700">Localidad</label>
                        <input type="text" id="localidad" name="localidad"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" />
                    </div>

                    <div>
                        <label for="origen" class="block text-sm font-medium text-gray-700">Origen Carga</label>
                        <select name="origen" id="origen"
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md">
                            <option value="">Todos</option>
                            <option th:each="o : ${origenesDeCarga}"
                                    th:value="${o.name()}"
                                    th:text="${o}"
                                    th:selected="${o.name() == filtrosActuales.origen}">
                            </option>
                        </select>
                    </div>
                </div>
            </fieldset>

            <!-- Botón -->
            <div class="flex justify-end items-center gap-4 pt-4">
                <a th:href="@{/admin(tab='collections')}"
                   class="px-6 py-3 bg-gray-200 text-gray-700 font-semibold rounded-md hover:bg-gray-300 transition-colors">
                    Cancelar
                </a>
                <button type="submit"
                        class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700">
                    Crear Colección
                </button>
            </div>

        </form>
    </div>
</main>

<div th:replace="~{layout/base :: footer}"></div>

<script>
    // Mostrar campo de categoría personalizada
    const categoriaSelect = document.getElementById('categoria');
    const customDiv = document.getElementById('customCategoriaDiv');
    categoriaSelect.addEventListener('change', () => {
        if(categoriaSelect.value === 'Otra') customDiv.classList.remove('hidden');
        else customDiv.classList.add('hidden');
    });

    // Búsqueda y autocompletado de país, provincia y localidad (sin mapa)
    const buscarBtn = document.getElementById("buscarUbicacion");
    const inputBuscar = document.getElementById("searchDireccion");

    buscarBtn.addEventListener("click", async () => {
        const query = inputBuscar.value.trim();
        if (!query) return alert("Por favor ingrese una dirección o ciudad para buscar.");

        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
            const data = await res.json();

            if (data.length === 0) {
                alert("No se encontró la ubicación especificada.");
                return;
            }

            // Tomamos el primer resultado
            const { lat, lon } = data[0];

            // Reverse geocoding para completar campos
            const reverseRes = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
            const reverseData = await reverseRes.json();
            const address = reverseData.address || {};

            document.getElementById('localidad').value = address.city || address.town || address.village || '';
            document.getElementById('provincia').value = address.state || '';
            document.getElementById('pais').value = address.country || '';

        } catch (err) {
            console.error("Error en la búsqueda:", err);
            alert("Ocurrió un error al buscar la dirección.");
        }
    });
</script>

<div th:replace="~{layout/base :: scripts}"></div>
</body>
</html>