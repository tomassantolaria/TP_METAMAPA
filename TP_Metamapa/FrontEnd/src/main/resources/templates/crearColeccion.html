<!DOCTYPE html>
<html lang="es">
<head th:replace="~{layout/base :: head (title='Crear hecho - Metamapa')}">
    <title>Crear Colección</title>
</head>
<body class="bg-gray-50">
<div th:replace="~{layout/base :: header}"></div>
<main class="container mx-auto px-4 py-8">
    <div class="max-w-3xl mx-auto bg-white p-6 rounded-lg shadow-md border border-blue-200">
        <h1 class="text-3xl font-bold text-blue-900 mb-6">Crear Colección</h1>

        <form class="space-y-4" action="#" method="POST">

            <!-- Título -->
            <div>
                <label for="titulo" class="block text-sm font-medium text-gray-700">Título</label>
                <input type="text" id="titulo" name="titulo" required
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" />
            </div>

            <!-- Descripción -->
            <div>
                <label for="descripcion" class="block text-sm font-medium text-gray-700">Descripción</label>
                <textarea id="descripcion" name="descripcion" rows="3" required
                          class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
            </div>

            <!-- Criterio de Consenso -->
            <div>
                <label for="criterioConsenso" class="block text-sm font-medium text-gray-700">Criterio de Consenso</label>
                <select id="criterioConsenso" name="criterioConsenso"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                    <option value="MAYORIA SIMPLE">MAYORÍA SIMPLE</option>
                    <option value="ABSOLUTA">ABSOLUTA</option>
                </select>
            </div>

            <!-- Criterios de Pertenencia -->
            <fieldset class="border-t border-gray-200 pt-5">
                <legend class="text-base font-medium text-gray-900 mb-2">Criterio de Pertenencia</legend>
                <p class="text-sm text-gray-500 mb-3">
                    Defina las reglas para que los hechos pertenezcan a esta colección. Complete al menos un campo.
                </p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="titulo-criterio" class="block text-sm font-medium text-gray-700">Título contiene</label>
                        <input type="text" id="titulo-criterio" name="titulo-criterio"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" />
                    </div>

                    <div>
                        <label for="categoria" class="block text-sm font-medium text-gray-700">Categoría es</label>
                        <select id="categoria" name="categoria"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                            <option value="">Cualquiera</option>
                            <option value="Economía">Economía</option>
                            <option value="Política">Política</option>
                            <option value="Ciencia">Ciencia</option>
                        </select>
                    </div>

                    <!-- País, Provincia/Estado, Localidad/Ciudad -->
                    <div>
                        <label for="pais" class="block text-sm font-medium text-gray-700">País</label>
                        <select id="pais" name="pais"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                            <option value="">Seleccione un país</option>
                        </select>
                    </div>

                    <div>
                        <label for="provincia" class="block text-sm font-medium text-gray-700">Provincia / Estado</label>
                        <select id="provincia" name="provincia"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" disabled>
                            <option value="">Seleccione una provincia</option>
                        </select>
                    </div>

                    <div>
                        <label for="localidad" class="block text-sm font-medium text-gray-700">Localidad / Ciudad</label>
                        <select id="localidad" name="localidad"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" disabled>
                            <option value="">Seleccione una localidad</option>
                        </select>
                    </div>

                    <div>
                        <label for="origen_carga" class="block text-sm font-medium text-gray-700">Origen de Carga</label>
                        <select id="origen_carga" name="origen_carga"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                            <option value="">Cualquiera</option>
                            <option value="Manual">Manual</option>
                            <option value="Automático">Automático</option>
                        </select>
                    </div>
                </div>
            </fieldset>

            <!-- Botón -->
            <div class="flex justify-end pt-4">
                <button type="submit"
                        class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700">
                    Crear Colección
                </button>
            </div>

        </form>
    </div>
</main>
<div th:replace="~{layout/base :: footer}"></div>
<script>
    const paisSelect = document.getElementById("pais");
    const provinciaSelect = document.getElementById("provincia");
    const localidadSelect = document.getElementById("localidad");

    // Función para buscar países por texto
    async function buscarPais(texto) {
        const res = await fetch(`https://nominatim.openstreetmap.org/search?country=${encodeURIComponent(texto)}&format=json&limit=50`);
        const data = await res.json();
        return data;
    }

    // Función para buscar provincias de un país
    async function buscarProvincias(pais) {
        const res = await fetch(`https://nominatim.openstreetmap.org/search?country=${encodeURIComponent(pais)}&format=json&limit=50&polygon_geojson=0`);
        const data = await res.json();
        // Filtrar resultados que tengan un "state"
        const estados = [...new Set(data.map(d => d.state).filter(Boolean))];
        return estados;
    }

    // Función para buscar ciudades dentro de un país y provincia
    async function buscarCiudades(pais, provincia) {
        const res = await fetch(`https://nominatim.openstreetmap.org/search?country=${encodeURIComponent(pais)}&state=${encodeURIComponent(provincia)}&format=json&limit=100`);
        const data = await res.json();
        // Filtrar nombres únicos de ciudades
        const ciudades = [...new Set(data.map(d => d.display_name.split(',')[0]))];
        return ciudades;
    }

    // Event listener para seleccionar país
    paisSelect.addEventListener("change", async () => {
        const pais = paisSelect.value;
        provinciaSelect.innerHTML = "<option value=''>Seleccione una provincia</option>";
        localidadSelect.innerHTML = "<option value=''>Seleccione una ciudad</option>";
        provinciaSelect.disabled = true;
        localidadSelect.disabled = true;

        if (!pais) return;

        const provincias = await buscarProvincias(pais);
        provincias.forEach(prov => {
            const opt = document.createElement("option");
            opt.value = prov;
            opt.textContent = prov;
            provinciaSelect.appendChild(opt);
        });
        provinciaSelect.disabled = false;
    });

    // Event listener para seleccionar provincia
    provinciaSelect.addEventListener("change", async () => {
        const pais = paisSelect.value;
        const provincia = provinciaSelect.value;
        localidadSelect.innerHTML = "<option value=''>Seleccione una ciudad</option>";
        localidadSelect.disabled = true;

        if (!provincia) return;

        const ciudades = await buscarCiudades(pais, provincia);
        ciudades.forEach(city => {
            const opt = document.createElement("option");
            opt.value = city;
            opt.textContent = city;
            localidadSelect.appendChild(opt);
        });
        localidadSelect.disabled = false;
    });

    // Opcional: precargar algunos países para el select
    ["Argentina","Uruguay","Brasil","Chile","México","España"].forEach(pais => {
        const opt = document.createElement("option");
        opt.value = pais;
        opt.textContent = pais;
        paisSelect.appendChild(opt);
    });
</script>


</body>
</html>
