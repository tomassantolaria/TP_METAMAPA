<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout/base :: head (title='Navegar - Metamapa')}"></head>
<body class="bg-pastel-blue-50 flex flex-col min-h-screen transition-colors duration-300 dark:bg-gray-900 dark:text-white">

<div th:replace="~{layout/base :: header}"></div>

<main class="w-full flex justify-center my-8 flex-grow">
    <div class="content-wrapper w-full max-w-screen-xl px-6 md:px-10 lg:px-16 flex flex-col">
        <form method="get" th:action="@{/navegar}" class="flex-grow flex flex-col">

            <div class="flex flex-col gap-6 h-[calc(100vh-12rem)]">

                <div class="search-bar-container">
                    <button type="button" id="toggleFiltros"
                            class="btn-filtros bg-pastel-blue-600 text-white font-semibold rounded-md hover:bg-pastel-blue-700 flex items-center gap-2">
                        <img th:src="@{/images/filtro.png}" alt="Icono filtro" class="w-4 h-4">
                        <span id="toggleText">Mostrar Filtros</span>
                    </button>

                    <input type="text" name="textoLibre" th:value="${filtrosActuales.textoLibre}"
                           placeholder="Búsqueda por texto libre..."
                           class="search-input border rounded-lg pl-3 pr-4 text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white"/>

                    <button type="submit" name="accion" value="buscarTexto"
                            class="btn-buscar bg-pastel-blue-600 text-white font-medium rounded-md hover:bg-pastel-blue-700 text-sm">
                        Buscar
                    </button>
                </div>

                <div class="flex flex-col md:flex-row gap-6 flex-grow min-h-0">
                    <div id="filtrosPanel" class="hidden md:w-1/3 lg:w-1/4 bg-white p-4 rounded-lg shadow-md border flex-col transition-all duration-300 overflow-x-hidden dark:bg-gray-800 dark:border-gray-700">
                        <h3 class="text-xl font-bold text-pastel-blue-900 mb-4 flex-shrink-0 dark:text-white">Filtros Avanzados</h3>
                        <div class="space-y-4 overflow-y-auto flex-grow px-2 overflow-x-hidden">
                            <div>
                                <label class="block text-sm font-medium dark:text-gray-300">Título</label>
                                <input type="text" name="titulo" th:value="${filtrosActuales.titulo}" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white"/>
                            </div>
                            <div>
                                <label class="block text-sm font-medium dark:text-gray-300">Colección</label>
                                <select name="coleccionId" id="coleccionSelect" class="mt-1 block w-full border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    <option value="">Ninguna</option>
                                    <option th:each="col : ${colecciones}" th:value="${col.coleccionId}" th:text="${col.titulo}" th:selected="${col.coleccionId.toString() == filtrosActuales.coleccionId.toString()}"></option>
                                </select>
                            </div>

                            <button type="submit" name="accion" value="filtrar" class="w-full mt-6 px-4 py-2 bg-pastel-blue-600 text-white font-semibold rounded-md hover:bg-pastel-blue-700">Aplicar</button>
                        </div>
                    </div>

                    <div id="contenidoPrincipal" class="w-full flex flex-col gap-4 min-h-0 transition-all duration-300">
                        <div class="flex-grow flex flex-col gap-4 min-h-0">
                            <div class="flex-grow flex flex-col md:flex-row gap-4 min-h-0">
                                <div id="mapaContainer" class="md:w-1/2 rounded-lg shadow-lg border overflow-hidden h-full min-h-[300px] md:min-h-0 border-pastel-blue-200 dark:border-gray-700">
                                    <div id="mapa" class="w-full h-full bg-pastel-blue-100 dark:bg-gray-800"></div>
                                </div>

                                <div id="resultadosContainer" class="md:w-1/2 flex flex-col gap-4 h-full min-h-[300px] md:min-h-0 transition-all duration-300">
                                    <h2 class="text-2xl font-bold text-pastel-blue-900 flex-shrink-0 dark:text-white">Resultados (<span th:text="${hechos.size()}">0</span>)</h2>
                                    <div class="flex-grow bg-white p-2 rounded-lg shadow-md border overflow-y-auto min-h-0 dark:bg-gray-800 dark:border-gray-700">
                                        <div th:if="${!hechos.isEmpty()}" class="space-y-3">
                                            <div th:each="hecho : ${hechos}">
                                                <div th:replace="~{fragments/hechoCard :: hechoCard(hecho=${hecho}, showOptions=true, showAdminActions = false, coleccionId=null)}"></div>
                                            </div>
                                        </div>
                                        <div th:if="${hechos.isEmpty()}" class="flex items-center justify-center h-full">
                                            <p class="text-center text-gray-500 dark:text-gray-400">No se encontraron hechos.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</main>

<div th:replace="~{layout/base :: footer}"></div>

<script th:inline="javascript">
        /*<![CDATA[*/

        // Toggle de filtros
        document.addEventListener('DOMContentLoaded', function() {
        // ... código del toggle ...
        const toggleBtn = document.getElementById('toggleFiltros');
        const filtrosPanel = document.getElementById('filtrosPanel');
        const contenidoPrincipal = document.getElementById('contenidoPrincipal');
        let filtrosVisibles = false;

        if(toggleBtn) {
            toggleBtn.addEventListener('click', function() {
                filtrosVisibles = !filtrosVisibles;
                if (filtrosVisibles) {
                    filtrosPanel.classList.remove('hidden');
                    filtrosPanel.classList.add('flex');
                    contenidoPrincipal.classList.add('md:w-2/3', 'lg:w-3/4');
                    contenidoPrincipal.classList.remove('md:w-full');
                    document.getElementById('toggleText').textContent = 'Ocultar Filtros';
                } else {
                    filtrosPanel.classList.add('hidden');
                    filtrosPanel.classList.remove('flex');
                    contenidoPrincipal.classList.remove('md:w-2/3', 'lg:w-3/4');
                    contenidoPrincipal.classList.add('md:w-full');
                    document.getElementById('toggleText').textContent = 'Mostrar Filtros';
                }
            });
        }
        // Navegación curada
        document.addEventListener('DOMContentLoaded', function() {
            const coleccionSelect = document.getElementById('coleccionSelect');
            const navegacionCuradaContainer = document.getElementById('navegacionCuradaContainer');

            if (!coleccionSelect || !navegacionCuradaContainer) {
                console.error('Error: No se encontraron los elementos para el filtro condicional.');
                return;
            }

            function actualizarVisibilidadNavegacionCurada() {
                if (coleccionSelect.value !== "") {
                    navegacionCuradaContainer.classList.remove('hidden');
                } else {
                    navegacionCuradaContainer.classList.add('hidden');
                }
            }

            coleccionSelect.addEventListener('change', actualizarVisibilidadNavegacionCurada);
            actualizarVisibilidadNavegacionCurada();
        });

        // Inicialización del mapa
        document.addEventListener('DOMContentLoaded', function() {
            const hechosData = /*[[${hechos}]]*/ [];
        if (typeof L !== 'undefined') {
            window.map = L.map('mapa').setView([-38.41, -63.61], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM' }).addTo(window.map);

            hechosData.forEach(hecho => {
                if (hecho.latitud && hecho.longitud) {
                    L.marker([hecho.latitud, hecho.longitud]).addTo(window.map)
                     .bindPopup(`<b>${hecho.titulo}</b><br><a href="/ver-hecho/${hecho.idHecho}">Ver más</a>`);
                }
            });
            setTimeout(() => window.map.invalidateSize(), 100);
        }
    });
</script>

<div th:replace="~{layout/base :: scripts}"></div>
</body>
</html>