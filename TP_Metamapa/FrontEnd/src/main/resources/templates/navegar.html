<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout/base :: head (title='Navegar - Metamapa')}"></head>
<body class="bg-pastel-blue-50 flex flex-col min-h-screen">

<div th:replace="~{layout/base :: header}"></div>

<main class="container mx-auto px-4 py-8 flex-grow flex flex-col">
    <form method="get" th:action="@{/navegar}" class="flex-grow flex flex-col md:flex-row gap-6">

            <div class="md:w-1/3 lg:w-1/4 h-full bg-white p-4 rounded-lg shadow-md border flex flex-col">
                <h3 class="text-xl font-bold text-pastel-blue-900 mb-4 flex-shrink-0">Filtros Avanzados</h3>
                <div class="space-y-4 overflow-y-auto flex-grow pr-2">
                    <div>
                        <label for="titulo" class="block text-sm font-medium text-gray-700">Título</label>
                        <input type="text" name="titulo" id="titulo" th:value="${filtrosActuales.titulo}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-pastel-blue-500 sm:text-sm"/>
                    </div>

                    <div>
                        <label for="coleccionSelect" class="block text-sm font-medium text-gray-700">Colección</label>
                        <select name="coleccionId" id="coleccionSelect" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md">
                            <option value="">Ninguna</option>
                            <option th:each="col : ${colecciones}"
                                    th:value="${col.coleccionId}"
                                    th:text="${col.titulo}"
                                    th:selected="${col.coleccionId.toString() == filtrosActuales.coleccionId}">
                            </option>
                        </select>
                    </div>

                    <div id="navegacionCuradaContainer" th:classappend="${(filtrosActuales.coleccionId == null || filtrosActuales.coleccionId.isEmpty()) ? 'hidden' : ''}" class="transition-all">
                        <label for="navegacionCurada" class="block text-sm font-medium text-gray-700">Modo de Navegación</label>
                        <select name="navegacionCurada" id="navegacionCurada" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md">
                            <option value="false" th:selected="${!filtrosActuales.navegacionCurada}">Irrestricta</option>
                            <option value="true" th:selected="${filtrosActuales.navegacionCurada}">Curada</option>
                        </select>
                    </div>

                    <div>
                        <label for="categoria" class="block text-sm font-medium text-gray-700">Categoría</label>
                        <select name="categoria" id="categoria" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md">
                            <option value="">Todas</option>
                            <option th:each="cat : ${categorias}"
                                    th:value="${cat}"
                                    th:text="${cat}"
                                    th:selected="${cat == filtrosActuales.categoria}">
                            </option>
                        </select>
                    </div>

                    <div>
                        <label for="contenidoMultimedia" class="block text-sm font-medium text-gray-700">Contenido Multimedia</label>
                        <select name="contenidoMultimedia" id="contenidoMultimedia" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md">
                            <option value="" th:selected="${filtrosActuales.contenidoMultimedia == null}">Sin Filtro</option>
                            <option value="true" th:selected="${filtrosActuales.contenidoMultimedia == true}">Sí</option>
                            <option value="false" th:selected="${filtrosActuales.contenidoMultimedia == false}">No</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Fecha de Carga</label>
                        <div class="flex items-center gap-2 mt-1">
                            <input type="date" name="fechaCargaDesde" th:value="${filtrosActuales.fechaCargaDesde}" class="block w-full px-3 py-2 border rounded-md text-sm"/>
                            <span>-</span>
                            <input type="date" name="fechaCargaHasta" th:value="${filtrosActuales.fechaCargaHasta}" class="block w-full px-3 py-2 border rounded-md text-sm"/>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Fecha Acontecimiento</label>
                        <div class="flex items-center gap-2 mt-1">
                            <input type="date" name="fechaHechoDesde" th:value="${filtrosActuales.fechaHechoDesde}" class="block w-full px-3 py-2 border rounded-md text-sm"/>
                            <span>-</span>
                            <input type="date" name="fechaHechoHasta" th:value="${filtrosActuales.fechaHechoHasta}" class="block w-full px-3 py-2 border rounded-md text-sm"/>
                        </div>
                    </div>

                    <div>
                        <label for="origen" class="block text-sm font-medium text-gray-700">Origen Carga</label>
                        <select name="origen" id="origen" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md">
                            <option value="">Todos</option>
                            <option th:each="o : ${origenesDeCarga}"
                                    th:value="${o.name()}"
                                    th:text="${o}"
                                    th:selected="${o.name() == filtrosActuales.origen}">
                            </option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Ubicación</label>
                        <div class="space-y-2 mt-1">
                            <select name="pais" class="block w-full px-3 py-2 border rounded-md sm:text-sm">
                                <option value="">Todos los Países</option>
                                <option th:each="p : ${paises}" th:value="${p}" th:text="${p}" th:selected="${p == filtrosActuales.pais}"></option>
                            </select>
                            <select name="provincia" class="block w-full px-3 py-2 border rounded-md sm:text-sm">
                                <option value="">Todas las Provincias</option>
                                <option th:each="p : ${provincias}" th:value="${p}" th:text="${p}" th:selected="${p == filtrosActuales.provincia}"></option>
                            </select>
                            <select name="localidad" class="block w-full px-3 py-2 border rounded-md sm:text-sm">
                                <option value="">Todas las Localidades</option>
                                <option th:each="l : ${localidades}" th:value="${l}" th:text="${l}" th:selected="${l == filtrosActuales.localidad}"></option>
                            </select>
                        </div>
                    </div>
                </div>
                <button type="submit" name="accion" value="filtrar" class="w-full mt-6 px-4 py-2 bg-pastel-blue-600 text-white font-semibold rounded-md hover:bg-pastel-blue-700">
                    Aplicar Filtros
                </button>
            </div>
            <div class="w-full md:w-2/3 lg:w-3/4 flex flex-col gap-4">

                <div class="relative flex gap-2 flex-shrink-0">
                    <input type="text" name="textoLibre" th:value="${filtrosActuales.textoLibre}" placeholder="Búsqueda por texto libre..." class="w-full pl-4 pr-10 py-3 border rounded-lg"/>
                    <button type="submit" name="accion" value="buscarTexto" class="px-4 py-2 bg-pastel-blue-600 text-white font-semibold rounded-md hover:bg-pastel-blue-700">
                        Buscar
                    </button>
                </div>

                <div class="flex-grow flex flex-col md:flex-row gap-4 overflow-hidden">

                    <div class="md:w-2/3 rounded-lg shadow-lg border overflow-hidden h-full">
                        <div id="mapa" class="w-full h-full bg-pastel-blue-100"></div>
                    </div>

                    <div class="md:w-1/3 flex flex-col gap-4 h-full">
                        <h2 class="text-2xl font-bold text-pastel-blue-900 flex-shrink-0">Resultados (<span th:text="${hechos.size()}">0</span>)</h2>
                        <div class="flex-grow bg-white p-2 rounded-lg shadow-md border overflow-y-auto">
                            <div th:if="${!hechos.isEmpty()}" class="space-y-3">
                                <div th:each="hecho : ${hechos}">
                                    <div th:replace="~{fragments/hechoCard :: hechoCard(hecho=${hecho}, showOptions=true)}"></div>
                                </div>
                            </div>
                            <div th:if="${hechos.isEmpty()}" class="flex items-center justify-center h-full">
                                <p class="text-center text-gray-500 p-8">No se encontraron hechos con los filtros aplicados.</p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
    </form> </main>

<div th:replace="~{layout/base :: footer}"></div>

<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function() {
        const coleccionSelect = document.getElementById('coleccionSelect');
        const navegacionCuradaContainer = document.getElementById('navegacionCuradaContainer');

        if (!coleccionSelect || !navegacionCuradaContainer) {
            console.error('Error: No se encontraron los elementos para el filtro condicional.');
            return;
        }

        function actualizarVisibilidadNavegacionCurada() {
            if (coleccionSelect.value !== "") {
                navegacionCuradaContainer.classList.remove('hidden');
            } else {
                navegacionCuradaContainer.classList.add('hidden');
            }
        }

        coleccionSelect.addEventListener('change', actualizarVisibilidadNavegacionCurada);
        actualizarVisibilidadNavegacionCurada(); // Ejecuta al cargar la página
    });
    document.addEventListener('DOMContentLoaded', function() {
        const hechosData = /*[[${hechos}]]*/ [];

        const map = L.map('mapa').setView([-38.41, -63.61], 4);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        hechosData.forEach(hecho => {
            if (hecho.latitud && hecho.longitud) {
                L.marker([hecho.latitud, hecho.longitud])
                    .addTo(map)
                    .bindPopup(`<b>${hecho.titulo}</b>`);
            }
        });
    });

    /*]]>*/
</script>
<div th:replace="~{layout/base :: scripts}"></div>
</body>
</html>